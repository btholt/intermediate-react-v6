<!DOCTYPE html><html><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width" data-next-head=""/><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png" data-next-head=""/><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" data-next-head=""/><link rel="icon" type="image/x-icon" href="/images/favicon.ico" data-next-head=""/><title data-next-head="">The RSC Server – Intermediate React v6</title><meta name="description" content="Explore how to use Fastify to serve a React app with server components by setting up a Node.js server that handles both client-side and server-side rendering. Written by Brian Holt for Frontend Masters, this guide offers step-by-step integration of React and Fastify, demonstrating the use of React Flight Protocol and reinforcing React&#x27;s modular framework for advanced web development." data-next-head=""/><meta name="keywords" content="React,Fastify,Node.js,Brian Holt,server components,web development,React Flight Protocol" data-next-head=""/><meta name="og:description" content="Explore how to use Fastify to serve a React app with server components by setting up a Node.js server that handles both client-side and server-side rendering. Written by Brian Holt for Frontend Masters, this guide offers step-by-step integration of React and Fastify, demonstrating the use of React Flight Protocol and reinforcing React&#x27;s modular framework for advanced web development." data-next-head=""/><meta name="og:title" content="The RSC Server – Intermediate React v6" data-next-head=""/><meta name="og:image" content="/images/social-share-cover.jpg" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><link data-next-font="size-adjust" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/_next/static/css/0732dfa8741dc542.css" as="style"/><link rel="stylesheet" href="/_next/static/css/0732dfa8741dc542.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-b66ed8ba6f029a99.js" defer=""></script><script src="/_next/static/chunks/framework-a4ddb9b21624b39b.js" defer=""></script><script src="/_next/static/chunks/main-d4c20200ddabac7f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-31cd0638bbee6098.js" defer=""></script><script src="/_next/static/chunks/pages/lessons/%5Bsection%5D/%5Bslug%5D-7da2347a1e0b6c73.js" defer=""></script><script src="/_next/static/81bftuYLGkwiC8AXLtnRs/_buildManifest.js" defer=""></script><script src="/_next/static/81bftuYLGkwiC8AXLtnRs/_ssgManifest.js" defer=""></script></head><body><script async="" defer="" src="https://a.holt.courses/latest.js"></script><div id="__next"><div class="remix-app"><header class="navbar"><h1 class="navbar-brand"><a href="/">Intermediate React v6</a></h1><div class="navbar-info"><a href="https://frontendmasters.com/courses/intermediate-react-v6/" class="cta-btn">Watch on Frontend Masters</a></div></header><div class="content-container"><div class="main"><div class="lesson-container"><div class="lesson"><div class="lesson-content"><p>So now we have a React app ready to be served to clients. Let&#39;s write a quick Fastify server to do this. I just chose Fastify because I like it; there&#39;s no reason you couldn&#39;t do Express, Restify, or any other API framework for Node.js.</p>
<p>Let&#39;s create a <code>server</code> directory in the root directory of our project. Put in there a main.js file and put in there</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">const</span> reactServerregister = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;react-server-dom-webpack/node-register&quot;</span>);
<span class="hljs-title function_">reactServerregister</span>();

<span class="hljs-keyword">const</span> babelRegister = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;@babel/register&quot;</span>);
<span class="hljs-title function_">babelRegister</span>({
  <span class="hljs-attr">ignore</span>: [<span class="hljs-regexp">/[\\\/](dist|server|node_modules)[\\\/]/</span>],
  <span class="hljs-attr">plugins</span>: [<span class="hljs-string">&quot;@babel/transform-modules-commonjs&quot;</span>],
});

<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./server&quot;</span>)();
</code></pre><ul>
<li>We&#39;re doing CommonJS for our server portion. I had it working with ES modules but it took so much extra code that this was simpler to teach you. Feel free to convert it later yourself. Everything else in this course will be ES modules.</li>
<li>This file does three things: it makes our Node.js server able to read React/JSX files, it makes it able to ES modules in our client code, and it makes it able to do RSCs via the webpack bundler by hooking into the module systems to render some portions and not others. Remember the <code>--conditions react-server</code> that we have in our CLI command? This is what that is for.</li>
<li>Why is this in a separate file? It&#39;s so all subsequent <code>require</code>/<code>import</code> calls can be run through Babel and the react-server-dom-webpack modules.</li>
</ul>
<p>Okay, let&#39;s start crafting our server.js file in the same directory. Let&#39;s just start with the basic machinery.</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;node:path&quot;</span>);
<span class="hljs-keyword">const</span> { readFileSync } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;node:fs&quot;</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Fastify</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;fastify&quot;</span>);
<span class="hljs-keyword">const</span> fastifyStaticPlugin = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;@fastify/static&quot;</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">React</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;react&quot;</span>);
<span class="hljs-keyword">const</span> { renderToPipeableStream } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;react-server-dom-webpack/server&quot;</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">AppImport</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;../src/App.jsx&quot;</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title class_">App</span> = <span class="hljs-title class_">AppImport</span>.<span class="hljs-property">default</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MANIFEST</span> = <span class="hljs-title function_">readFileSync</span>(
  path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&quot;../dist/react-client-manifest.json&quot;</span>),
  <span class="hljs-string">&quot;utf8&quot;</span>
);
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MODULE_MAP</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable constant_">MANIFEST</span>);
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PORT</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> ? process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> : <span class="hljs-number">3000</span>;

<span class="hljs-keyword">const</span> fastify = <span class="hljs-title class_">Fastify</span>({
  <span class="hljs-attr">logger</span>: {
    <span class="hljs-attr">transport</span>: {
      <span class="hljs-attr">target</span>: <span class="hljs-string">&quot;pino-pretty&quot;</span>,
    },
  },
});

fastify.<span class="hljs-title function_">register</span>(fastifyStaticPlugin, {
  <span class="hljs-attr">root</span>: path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&quot;../dist&quot;</span>),
  <span class="hljs-attr">prefix</span>: <span class="hljs-string">&quot;/assets/&quot;</span>,
});

fastify.<span class="hljs-title function_">register</span>(fastifyStaticPlugin, {
  <span class="hljs-attr">root</span>: path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&quot;../public&quot;</span>),
  <span class="hljs-attr">decorateReply</span>: <span class="hljs-literal">false</span>,
});

fastify.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">rootHandler</span>(<span class="hljs-params">request, reply</span>) {
  <span class="hljs-keyword">return</span> reply.<span class="hljs-title function_">sendFile</span>(<span class="hljs-string">&quot;index.html&quot;</span>);
});

fastify.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/react-flight&quot;</span>, <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactFlightHandler</span>(<span class="hljs-params">request, reply</span>) {
  <span class="hljs-comment">// we&#x27;ll do this code in a sec</span>
});

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">start</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> fastify.<span class="hljs-title function_">listen</span>({ <span class="hljs-attr">port</span>: <span class="hljs-variable constant_">PORT</span> });
  } <span class="hljs-keyword">catch</span> (err) {
    fastify.<span class="hljs-property">log</span>.<span class="hljs-title function_">error</span>(err);
    process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>);
  }
};
</code></pre><ul>
<li>Pretty standard Fastify app. We&#39;re serving two static folders, <code>public</code> which is our CSS but also could be images and some other stuff. It&#39;s stuff that doesn&#39;t need to be compiled and just served directly. <code>dist</code> is our compiled Webpack stuff.</li>
<li>We&#39;re importing <code>react-server-dom-webpack/server</code> to be able to correctly serve our app here momentarily.</li>
<li>Same with our App.jsx. Notice we&#39;re not importing Client.jsx - that&#39;s all code that&#39;ll only execute client side.</li>
<li>The module map is something that <code>react-server-dom-webpack</code> generates and let&#39;s React how to know what module to what.</li>
</ul>
<p>Alright, let&#39;s render our app next. But let&#39;s cheat. Let&#39;s just give it directly some &quot;React Flight&quot; to render instead of the actual app.</p>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// replace the react-flight route</span>
fastify.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/react-flight&quot;</span>, <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactFlightHandler</span>(<span class="hljs-params">request, reply</span>) {
  <span class="hljs-keyword">try</span> {
    reply.<span class="hljs-title function_">header</span>(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/octet-stream&quot;</span>);
    <span class="hljs-comment">// be careful about whitespace as React Flight is sensitive to it. Make your editor isn&#x27;t inserting any</span>
    <span class="hljs-keyword">return</span> reply.<span class="hljs-title function_">send</span>(<span class="hljs-string">`1:{&quot;name&quot;:&quot;App&quot;,&quot;env&quot;:&quot;Server&quot;,&quot;key&quot;:null,&quot;owner&quot;:null,&quot;props&quot;:{}}
0:D&quot;$1&quot;
0:[&quot;$&quot;,&quot;div&quot;,null,{&quot;children&quot;:[&quot;$&quot;,&quot;h1&quot;,null,{&quot;children&quot;:&quot;Notes App&quot;},&quot;$1&quot;]},&quot;$1&quot;]
`</span>);
  } <span class="hljs-keyword">catch</span> (err) {
    request.<span class="hljs-property">log</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;react-flight err&quot;</span>, err);
    <span class="hljs-keyword">throw</span> err;
  }
});
</code></pre><blockquote>
<p>💡 This is prone to breaking as this protocol is unstable and they may choose to change it in the future. However the principles remain the same. If you see something about webpack complaining in the errors, just skip this code sample and go to the next code block.</p>
</blockquote>
<ul>
<li>So what is that weird string in there? It&#39;s called React Flight Protocol and it&#39;s how React&#39;s server and client protocol work with each other.</li>
<li>You&#39;ll never write this by hand. But I wanted to show you it&#39;s not very scary, it&#39;s just a DSL for communicating between a client and a server, and in theory you could hand author it - you just never would.</li>
</ul>
<p>Let&#39;s take it one half step further.</p>
<pre><code class="hljs language-javascript"><span class="hljs-comment">// replace reply.send</span>

<span class="hljs-comment">// be careful about whitespace as React Flight is sensitive to it. Make your editor isn&#x27;t inserting any</span>
<span class="hljs-keyword">return</span> reply.<span class="hljs-title function_">send</span>(<span class="hljs-string">`3:I[&quot;./src/ClientComponent.jsx&quot;,[&quot;vendors-node_modules_react_jsx-dev-runtime_js&quot;,&quot;vendors-node_modules_react_jsx-dev-runtime_js.chunk.js&quot;,&quot;client0&quot;,&quot;client0.chunk.js&quot;],&quot;&quot;]
1:{&quot;name&quot;:&quot;App&quot;,&quot;env&quot;:&quot;Server&quot;,&quot;key&quot;:null,&quot;owner&quot;:null,&quot;props&quot;:{}}
0:D&quot;$1&quot;
0:[&quot;$&quot;,&quot;div&quot;,null,{&quot;children&quot;:[[&quot;$&quot;,&quot;h1&quot;,null,{&quot;children&quot;:&quot;Notes App&quot;},&quot;$1&quot;],[&quot;$&quot;,&quot;$L3&quot;,null,{},&quot;$1&quot;]]},&quot;$1&quot;]
`</span>);
</code></pre><ul>
<li>This may not work for you due to paths (and again, you&#39;d never hand author this so don&#39;t worry if it doesn&#39;t.)</li>
<li>This is cool though because you can see how React is referencing a client component. It&#39;s basically saying here&#39;s a div, and in it has an h1 and a &quot;$L3&quot;. It then defines a &quot;3&quot; on the first line where it has <code>3:I</code>. Here it&#39;s saying anywhere that you have a 3 component, it refers to a ClientComponent, and that&#39;s going to be in this specific bundle, go find that and use it.</li>
<li>Pretty cool, right?</li>
<li>I genuinely don&#39;t know what some of the pieces here do, but it&#39;s fun to hack around and see what you can bend React to do.</li>
</ul>
<p>Okay, let&#39;s actually put the real code in here.</p>
<pre><code class="hljs language-javascript">fastify.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/react-flight&quot;</span>, <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactFlightHandler</span>(<span class="hljs-params">request, reply</span>) {
  <span class="hljs-keyword">try</span> {
    reply.<span class="hljs-title function_">header</span>(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/octet-stream&quot;</span>);
    <span class="hljs-keyword">const</span> { pipe } = <span class="hljs-title function_">renderToPipeableStream</span>(
      <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-title class_">App</span>),
      <span class="hljs-variable constant_">MODULE_MAP</span>
    );
    <span class="hljs-title function_">pipe</span>(reply.<span class="hljs-property">raw</span>);
  } <span class="hljs-keyword">catch</span> (err) {
    request.<span class="hljs-property">log</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;react-flight err&quot;</span>, err);
    <span class="hljs-keyword">throw</span> err;
  }
});
</code></pre><ul>
<li>This will actually render your app based on what your App.jsx has (whereas we were &quot;rendering&quot; it ourselves before.)</li>
<li>The way we coded this it will only really work for the base route of your app. If you tried to introduce a router or more components here, we haven&#39;t provided for the ability to route to different routes. You&#39;d have to code that up yourself.</li>
<li>Likewise we&#39;re not handing any props to App.</li>
<li>This is <em>not</em> server-side rendering. The way you&#39;d do that is you&#39;d render the React Flight protocol, dump it into a script tag in the HTML, and have your app read that and use it to render your app on load. A little awkward but again, generally your framework will handle that for you.</li>
<li>Check out the react-flight request in your network tab to see how it gets rendered out.</li>
<li>I also like it shows you <code>Server</code> logs directly in the browser, makes it easy to see client and server console.logs in the same place.</li>
</ul>
<p>So there you go! Now your app is rendering partially on the server, partially on the client, and you&#39;ve hand-coded it all! This is a pain to do but once you involve a framework like Next.js this gets so much easier. Still, amazing job! Hopefully you peeked a little bit behind the curtain to see what React is doing for you.</p>
</div><div class="lesson-links"><a href="/lessons/rscs-without-a-framework/server-and-client-components" class="prev">← Previous</a><a href="/lessons/rscs-with-nextjs/abbreviated-intro-to-nextjs" class="next">Next →</a></div></div><div class="details-bg"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="154" height="154" viewBox="0 0 154 154"><defs><clipPath id="clip-path"><rect id="Rectangle_2238" data-name="Rectangle 2238" width="154" height="154" transform="translate(9467 350)" fill="#fff" stroke="#707070" stroke-width="1"></rect></clipPath><clipPath id="clip-corner-image-active"><rect width="154" height="154"></rect></clipPath></defs><g id="corner-image-active" clip-path="url(#clip-corner-image-active)"><g id="Corner-image-active-2" data-name="Corner-image-active" transform="translate(-9467 -350)" clip-path="url(#clip-path)"><path id="Subtraction_34" data-name="Subtraction 34" d="M-3857.365,1740.766h0l-7.07-7.07,12.89-12.89v14.142l-5.818,5.818Zm-14.142-14.142h0l-7.071-7.07,27.033-27.033v14.143l-19.96,19.96Zm-14.143-14.143h0l-7.07-7.069,41.175-41.175v14.142Zm-14.142-14.142h0l-7.07-7.069,55.317-55.317v14.142Zm-14.142-14.142h0l-7.07-7.069,69.459-69.459v14.142Zm-14.142-14.142h0l-7.07-7.069,76.739-76.739h6.862v7.28Zm-14.143-14.143h0l-7.07-7.069,62.6-62.6h14.142Zm-14.142-14.142h0l-7.07-7.069,48.454-48.454h14.142Zm-14.142-14.142h0l-7.07-7.069,34.312-34.312h14.142Zm-14.142-14.142h0l-7.07-7.069,20.17-20.17h14.142Zm-14.142-14.142h0l-7.071-7.071,6.027-6.027h14.144l-13.1,13.1Zm367.24-56.114v-.909l.455.455-.453.453Z" transform="translate(13472.546 -1236.766)" fill="var(--corner-fill)"></path></g></g></svg></div></div></div></div><noscript><img src="https://a.holt.courses/noscript.gif" alt="" referrerPolicy="no-referrer-when-downgrade"/></noscript><footer class="footer"><ul class="socials"><li class="social"><a href="https://twitter.com/holtbt"><svg fill="none" height="auto" width="32" xmlns="http://www.w3.org/2000/svg" viewBox="0.254 0.25 500 451.95400000000006"><path d="M394.033.25h76.67L303.202 191.693l197.052 260.511h-154.29L225.118 294.205 86.844 452.204H10.127l179.16-204.77L.254.25H158.46l109.234 144.417zm-26.908 406.063h42.483L135.377 43.73h-45.59z" fill="var(--footer-icons)"></path></svg></a></li><li class="social"><a href="https://bsky.app/profile/brianholt.me"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -3.268 64 68.414" width="38" height="auto"><path fill="var(--footer-icons)" d="M13.873 3.805C21.21 9.332 29.103 20.537 32 26.55v15.882c0-.338-.13.044-.41.867-1.512 4.456-7.418 21.847-20.923 7.944-7.111-7.32-3.819-14.64 9.125-16.85-7.405 1.264-15.73-.825-18.014-9.015C1.12 23.022 0 8.51 0 6.55 0-3.268 8.579-.182 13.873 3.805zm36.254 0C42.79 9.332 34.897 20.537 32 26.55v15.882c0-.338.13.044.41.867 1.512 4.456 7.418 21.847 20.923 7.944 7.111-7.32 3.819-14.64-9.125-16.85 7.405 1.264 15.73-.825 18.014-9.015C62.88 23.022 64 8.51 64 6.55c0-9.818-8.578-6.732-13.873-2.745z"></path></svg></a></li><li class="social"><a href="https://github.com/btholt"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-github-social"><rect width="32" height="32"></rect></clipPath></defs><g id="github-social" clip-path="url(#clip-github-social)"><g id="Group_272" data-name="Group 272" transform="translate(13522.5 -6994)"><path id="Subtraction_33" data-name="Subtraction 33" d="M-24967.5,8041a15.9,15.9,0,0,1-11.312-4.688A15.893,15.893,0,0,1-24983.5,8025a15.893,15.893,0,0,1,4.689-11.315A15.894,15.894,0,0,1-24967.5,8009a15.894,15.894,0,0,1,11.313,4.686A15.893,15.893,0,0,1-24951.5,8025a15.893,15.893,0,0,1-4.689,11.313A15.9,15.9,0,0,1-24967.5,8041Zm-3.781-4.571h0v3.918h7.895v-6.665a1.836,1.836,0,0,0-1.2-1.718c5.1-.617,7.467-2.975,7.467-7.424a7.176,7.176,0,0,0-1.637-4.728,6.74,6.74,0,0,0,.275-1.812,4.34,4.34,0,0,0-.52-2.452.574.574,0,0,0-.359-.1c-1.061,0-3.465,1.411-3.936,1.694a16.644,16.644,0,0,0-4.2-.489,16.379,16.379,0,0,0-3.969.445c-.846-.5-2.91-1.649-3.859-1.649a.566.566,0,0,0-.354.095,4.3,4.3,0,0,0-.521,2.452,6.7,6.7,0,0,0,.244,1.718,7.346,7.346,0,0,0-1.6,4.822,7.263,7.263,0,0,0,1.533,4.985c1.193,1.359,3.115,2.165,5.871,2.464a1.826,1.826,0,0,0-1.129,1.693v.5h0l-.006,0a7.121,7.121,0,0,1-2.033.363,2.608,2.608,0,0,1-.965-.158,4.438,4.438,0,0,1-1.836-1.881,2.361,2.361,0,0,0-1.248-1.091,3.472,3.472,0,0,0-1.217-.3.584.584,0,0,0-.545.224.282.282,0,0,0,.027.367,1.875,1.875,0,0,0,.447.307,4.732,4.732,0,0,1,.561.355,10.726,10.726,0,0,1,1.682,2.755c.043.092.078.163.105.217a3.876,3.876,0,0,0,2.42,1.185,6.036,6.036,0,0,0,.607.025c.875,0,1.988-.124,2-.125Z" transform="translate(11461 -1015)" fill="var(--footer-icons)"></path><g id="Ellipse_670" data-name="Ellipse 670" transform="translate(-13522.5 6994)" fill="none" stroke="var(--footer-icons)" stroke-width="1"><circle cx="16" cy="16" r="16" stroke="none"></circle><circle cx="16" cy="16" r="15.5" fill="none"></circle></g></g></g></svg></a></li><li class="social"><a href="https://linkedin.com/in/btholt"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32" height="32" viewBox="0 0 32 32"><defs><clipPath id="clip-linkedin-social"><rect width="32" height="32"></rect></clipPath></defs><g id="linkedin-social" clip-path="url(#clip-linkedin-social)"><g id="Group_270" data-name="Group 270" transform="translate(-86.349 -633.073)"><path id="Path_375" data-name="Path 375" d="M115.789,633.073a2.324,2.324,0,0,1,1.682.676,2.194,2.194,0,0,1,.695,1.627V662.8a2.131,2.131,0,0,1-.695,1.609,2.314,2.314,0,0,1-1.646.659H88.69a2.307,2.307,0,0,1-1.646-.659,2.128,2.128,0,0,1-.695-1.609V635.376a2.19,2.19,0,0,1,.695-1.627,2.322,2.322,0,0,1,1.682-.676h27.063Zm-20.224,9.672a2.561,2.561,0,0,0,0-3.584,2.658,2.658,0,0,0-1.938-.712,2.724,2.724,0,0,0-1.957.712,2.371,2.371,0,0,0-.75,1.792,2.4,2.4,0,0,0,.731,1.792,2.605,2.605,0,0,0,1.9.713h.037A2.7,2.7,0,0,0,95.565,642.745ZM96,645.434H91.213V659.88H96Zm17.3,6.144a7.007,7.007,0,0,0-1.573-4.9,5.68,5.68,0,0,0-6.839-.769,5.663,5.663,0,0,0-1.426,1.573v-2.048H98.674q.036.841,0,7.717v6.728h4.791V651.8a3.592,3.592,0,0,1,.146-1.17,2.913,2.913,0,0,1,.878-1.206,2.429,2.429,0,0,1,1.609-.549,2.108,2.108,0,0,1,1.865.914,4.265,4.265,0,0,1,.549,2.341v7.752H113.3Z" fill="var(--footer-icons)"></path></g></g></svg></a></li><li class="social"><div class="terms"><p>Content Licensed Under CC-BY-NC-4.0</p><p>Code Samples and Exercises Licensed Under Apache 2.0</p><p>Site Designed by<!-- --> <a href="https://www.alexdanielson.com/">Alex Danielson</a></p></div></li></ul></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"attributes":{"title":"The RSC Server","description":"Explore how to use Fastify to serve a React app with server components by setting up a Node.js server that handles both client-side and server-side rendering. Written by Brian Holt for Frontend Masters, this guide offers step-by-step integration of React and Fastify, demonstrating the use of React Flight Protocol and reinforcing React's modular framework for advanced web development.","keywords":["React","Fastify","Node.js","Brian Holt","server components","web development","React Flight Protocol"]},"html":"\u003cp\u003eSo now we have a React app ready to be served to clients. Let\u0026#39;s write a quick Fastify server to do this. I just chose Fastify because I like it; there\u0026#39;s no reason you couldn\u0026#39;t do Express, Restify, or any other API framework for Node.js.\u003c/p\u003e\n\u003cp\u003eLet\u0026#39;s create a \u003ccode\u003eserver\u003c/code\u003e directory in the root directory of our project. Put in there a main.js file and put in there\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e reactServerregister = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;react-server-dom-webpack/node-register\u0026quot;\u003c/span\u003e);\n\u003cspan class=\"hljs-title function_\"\u003ereactServerregister\u003c/span\u003e();\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e babelRegister = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;@babel/register\u0026quot;\u003c/span\u003e);\n\u003cspan class=\"hljs-title function_\"\u003ebabelRegister\u003c/span\u003e({\n  \u003cspan class=\"hljs-attr\"\u003eignore\u003c/span\u003e: [\u003cspan class=\"hljs-regexp\"\u003e/[\\\\\\/](dist|server|node_modules)[\\\\\\/]/\u003c/span\u003e],\n  \u003cspan class=\"hljs-attr\"\u003eplugins\u003c/span\u003e: [\u003cspan class=\"hljs-string\"\u003e\u0026quot;@babel/transform-modules-commonjs\u0026quot;\u003c/span\u003e],\n});\n\n\u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;./server\u0026quot;\u003c/span\u003e)();\n\u003c/code\u003e\u003c/pre\u003e\u003cul\u003e\n\u003cli\u003eWe\u0026#39;re doing CommonJS for our server portion. I had it working with ES modules but it took so much extra code that this was simpler to teach you. Feel free to convert it later yourself. Everything else in this course will be ES modules.\u003c/li\u003e\n\u003cli\u003eThis file does three things: it makes our Node.js server able to read React/JSX files, it makes it able to ES modules in our client code, and it makes it able to do RSCs via the webpack bundler by hooking into the module systems to render some portions and not others. Remember the \u003ccode\u003e--conditions react-server\u003c/code\u003e that we have in our CLI command? This is what that is for.\u003c/li\u003e\n\u003cli\u003eWhy is this in a separate file? It\u0026#39;s so all subsequent \u003ccode\u003erequire\u003c/code\u003e/\u003ccode\u003eimport\u003c/code\u003e calls can be run through Babel and the react-server-dom-webpack modules.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eOkay, let\u0026#39;s start crafting our server.js file in the same directory. Let\u0026#39;s just start with the basic machinery.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e path = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;node:path\u0026quot;\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { readFileSync } = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;node:fs\u0026quot;\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eFastify\u003c/span\u003e = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;fastify\u0026quot;\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e fastifyStaticPlugin = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;@fastify/static\u0026quot;\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eReact\u003c/span\u003e = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;react\u0026quot;\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { renderToPipeableStream } = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;react-server-dom-webpack/server\u0026quot;\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eAppImport\u003c/span\u003e = \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;../src/App.jsx\u0026quot;\u003c/span\u003e);\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eApp\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eAppImport\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edefault\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eMANIFEST\u003c/span\u003e = \u003cspan class=\"hljs-title function_\"\u003ereadFileSync\u003c/span\u003e(\n  path.\u003cspan class=\"hljs-title function_\"\u003eresolve\u003c/span\u003e(__dirname, \u003cspan class=\"hljs-string\"\u003e\u0026quot;../dist/react-client-manifest.json\u0026quot;\u003c/span\u003e),\n  \u003cspan class=\"hljs-string\"\u003e\u0026quot;utf8\u0026quot;\u003c/span\u003e\n);\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eMODULE_MAP\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003eJSON\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eparse\u003c/span\u003e(\u003cspan class=\"hljs-variable constant_\"\u003eMANIFEST\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003ePORT\u003c/span\u003e = process.\u003cspan class=\"hljs-property\"\u003eenv\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ePORT\u003c/span\u003e ? process.\u003cspan class=\"hljs-property\"\u003eenv\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003ePORT\u003c/span\u003e : \u003cspan class=\"hljs-number\"\u003e3000\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e fastify = \u003cspan class=\"hljs-title class_\"\u003eFastify\u003c/span\u003e({\n  \u003cspan class=\"hljs-attr\"\u003elogger\u003c/span\u003e: {\n    \u003cspan class=\"hljs-attr\"\u003etransport\u003c/span\u003e: {\n      \u003cspan class=\"hljs-attr\"\u003etarget\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;pino-pretty\u0026quot;\u003c/span\u003e,\n    },\n  },\n});\n\nfastify.\u003cspan class=\"hljs-title function_\"\u003eregister\u003c/span\u003e(fastifyStaticPlugin, {\n  \u003cspan class=\"hljs-attr\"\u003eroot\u003c/span\u003e: path.\u003cspan class=\"hljs-title function_\"\u003ejoin\u003c/span\u003e(__dirname, \u003cspan class=\"hljs-string\"\u003e\u0026quot;../dist\u0026quot;\u003c/span\u003e),\n  \u003cspan class=\"hljs-attr\"\u003eprefix\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\u0026quot;/assets/\u0026quot;\u003c/span\u003e,\n});\n\nfastify.\u003cspan class=\"hljs-title function_\"\u003eregister\u003c/span\u003e(fastifyStaticPlugin, {\n  \u003cspan class=\"hljs-attr\"\u003eroot\u003c/span\u003e: path.\u003cspan class=\"hljs-title function_\"\u003ejoin\u003c/span\u003e(__dirname, \u003cspan class=\"hljs-string\"\u003e\u0026quot;../public\u0026quot;\u003c/span\u003e),\n  \u003cspan class=\"hljs-attr\"\u003edecorateReply\u003c/span\u003e: \u003cspan class=\"hljs-literal\"\u003efalse\u003c/span\u003e,\n});\n\nfastify.\u003cspan class=\"hljs-title function_\"\u003eget\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003erootHandler\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003erequest, reply\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e reply.\u003cspan class=\"hljs-title function_\"\u003esendFile\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;index.html\u0026quot;\u003c/span\u003e);\n});\n\nfastify.\u003cspan class=\"hljs-title function_\"\u003eget\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/react-flight\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ereactFlightHandler\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003erequest, reply\u003c/span\u003e) {\n  \u003cspan class=\"hljs-comment\"\u003e// we\u0026#x27;ll do this code in a sec\u003c/span\u003e\n});\n\n\u003cspan class=\"hljs-variable language_\"\u003emodule\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003eexports\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003easync\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003estart\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003e\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003eawait\u003c/span\u003e fastify.\u003cspan class=\"hljs-title function_\"\u003elisten\u003c/span\u003e({ \u003cspan class=\"hljs-attr\"\u003eport\u003c/span\u003e: \u003cspan class=\"hljs-variable constant_\"\u003ePORT\u003c/span\u003e });\n  } \u003cspan class=\"hljs-keyword\"\u003ecatch\u003c/span\u003e (err) {\n    fastify.\u003cspan class=\"hljs-property\"\u003elog\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eerror\u003c/span\u003e(err);\n    process.\u003cspan class=\"hljs-title function_\"\u003eexit\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e);\n  }\n};\n\u003c/code\u003e\u003c/pre\u003e\u003cul\u003e\n\u003cli\u003ePretty standard Fastify app. We\u0026#39;re serving two static folders, \u003ccode\u003epublic\u003c/code\u003e which is our CSS but also could be images and some other stuff. It\u0026#39;s stuff that doesn\u0026#39;t need to be compiled and just served directly. \u003ccode\u003edist\u003c/code\u003e is our compiled Webpack stuff.\u003c/li\u003e\n\u003cli\u003eWe\u0026#39;re importing \u003ccode\u003ereact-server-dom-webpack/server\u003c/code\u003e to be able to correctly serve our app here momentarily.\u003c/li\u003e\n\u003cli\u003eSame with our App.jsx. Notice we\u0026#39;re not importing Client.jsx - that\u0026#39;s all code that\u0026#39;ll only execute client side.\u003c/li\u003e\n\u003cli\u003eThe module map is something that \u003ccode\u003ereact-server-dom-webpack\u003c/code\u003e generates and let\u0026#39;s React how to know what module to what.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eAlright, let\u0026#39;s render our app next. But let\u0026#39;s cheat. Let\u0026#39;s just give it directly some \u0026quot;React Flight\u0026quot; to render instead of the actual app.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// replace the react-flight route\u003c/span\u003e\nfastify.\u003cspan class=\"hljs-title function_\"\u003eget\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/react-flight\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ereactFlightHandler\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003erequest, reply\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e {\n    reply.\u003cspan class=\"hljs-title function_\"\u003eheader\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;Content-Type\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;application/octet-stream\u0026quot;\u003c/span\u003e);\n    \u003cspan class=\"hljs-comment\"\u003e// be careful about whitespace as React Flight is sensitive to it. Make your editor isn\u0026#x27;t inserting any\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e reply.\u003cspan class=\"hljs-title function_\"\u003esend\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e`1:{\u0026quot;name\u0026quot;:\u0026quot;App\u0026quot;,\u0026quot;env\u0026quot;:\u0026quot;Server\u0026quot;,\u0026quot;key\u0026quot;:null,\u0026quot;owner\u0026quot;:null,\u0026quot;props\u0026quot;:{}}\n0:D\u0026quot;$1\u0026quot;\n0:[\u0026quot;$\u0026quot;,\u0026quot;div\u0026quot;,null,{\u0026quot;children\u0026quot;:[\u0026quot;$\u0026quot;,\u0026quot;h1\u0026quot;,null,{\u0026quot;children\u0026quot;:\u0026quot;Notes App\u0026quot;},\u0026quot;$1\u0026quot;]},\u0026quot;$1\u0026quot;]\n`\u003c/span\u003e);\n  } \u003cspan class=\"hljs-keyword\"\u003ecatch\u003c/span\u003e (err) {\n    request.\u003cspan class=\"hljs-property\"\u003elog\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eerror\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;react-flight err\u0026quot;\u003c/span\u003e, err);\n    \u003cspan class=\"hljs-keyword\"\u003ethrow\u003c/span\u003e err;\n  }\n});\n\u003c/code\u003e\u003c/pre\u003e\u003cblockquote\u003e\n\u003cp\u003e💡 This is prone to breaking as this protocol is unstable and they may choose to change it in the future. However the principles remain the same. If you see something about webpack complaining in the errors, just skip this code sample and go to the next code block.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cul\u003e\n\u003cli\u003eSo what is that weird string in there? It\u0026#39;s called React Flight Protocol and it\u0026#39;s how React\u0026#39;s server and client protocol work with each other.\u003c/li\u003e\n\u003cli\u003eYou\u0026#39;ll never write this by hand. But I wanted to show you it\u0026#39;s not very scary, it\u0026#39;s just a DSL for communicating between a client and a server, and in theory you could hand author it - you just never would.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eLet\u0026#39;s take it one half step further.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003e\u003cspan class=\"hljs-comment\"\u003e// replace reply.send\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e// be careful about whitespace as React Flight is sensitive to it. Make your editor isn\u0026#x27;t inserting any\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e reply.\u003cspan class=\"hljs-title function_\"\u003esend\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e`3:I[\u0026quot;./src/ClientComponent.jsx\u0026quot;,[\u0026quot;vendors-node_modules_react_jsx-dev-runtime_js\u0026quot;,\u0026quot;vendors-node_modules_react_jsx-dev-runtime_js.chunk.js\u0026quot;,\u0026quot;client0\u0026quot;,\u0026quot;client0.chunk.js\u0026quot;],\u0026quot;\u0026quot;]\n1:{\u0026quot;name\u0026quot;:\u0026quot;App\u0026quot;,\u0026quot;env\u0026quot;:\u0026quot;Server\u0026quot;,\u0026quot;key\u0026quot;:null,\u0026quot;owner\u0026quot;:null,\u0026quot;props\u0026quot;:{}}\n0:D\u0026quot;$1\u0026quot;\n0:[\u0026quot;$\u0026quot;,\u0026quot;div\u0026quot;,null,{\u0026quot;children\u0026quot;:[[\u0026quot;$\u0026quot;,\u0026quot;h1\u0026quot;,null,{\u0026quot;children\u0026quot;:\u0026quot;Notes App\u0026quot;},\u0026quot;$1\u0026quot;],[\u0026quot;$\u0026quot;,\u0026quot;$L3\u0026quot;,null,{},\u0026quot;$1\u0026quot;]]},\u0026quot;$1\u0026quot;]\n`\u003c/span\u003e);\n\u003c/code\u003e\u003c/pre\u003e\u003cul\u003e\n\u003cli\u003eThis may not work for you due to paths (and again, you\u0026#39;d never hand author this so don\u0026#39;t worry if it doesn\u0026#39;t.)\u003c/li\u003e\n\u003cli\u003eThis is cool though because you can see how React is referencing a client component. It\u0026#39;s basically saying here\u0026#39;s a div, and in it has an h1 and a \u0026quot;$L3\u0026quot;. It then defines a \u0026quot;3\u0026quot; on the first line where it has \u003ccode\u003e3:I\u003c/code\u003e. Here it\u0026#39;s saying anywhere that you have a 3 component, it refers to a ClientComponent, and that\u0026#39;s going to be in this specific bundle, go find that and use it.\u003c/li\u003e\n\u003cli\u003ePretty cool, right?\u003c/li\u003e\n\u003cli\u003eI genuinely don\u0026#39;t know what some of the pieces here do, but it\u0026#39;s fun to hack around and see what you can bend React to do.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eOkay, let\u0026#39;s actually put the real code in here.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-javascript\"\u003efastify.\u003cspan class=\"hljs-title function_\"\u003eget\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/react-flight\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003ereactFlightHandler\u003c/span\u003e(\u003cspan class=\"hljs-params\"\u003erequest, reply\u003c/span\u003e) {\n  \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e {\n    reply.\u003cspan class=\"hljs-title function_\"\u003eheader\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;Content-Type\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;application/octet-stream\u0026quot;\u003c/span\u003e);\n    \u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e { pipe } = \u003cspan class=\"hljs-title function_\"\u003erenderToPipeableStream\u003c/span\u003e(\n      \u003cspan class=\"hljs-title class_\"\u003eReact\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003ecreateElement\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eApp\u003c/span\u003e),\n      \u003cspan class=\"hljs-variable constant_\"\u003eMODULE_MAP\u003c/span\u003e\n    );\n    \u003cspan class=\"hljs-title function_\"\u003epipe\u003c/span\u003e(reply.\u003cspan class=\"hljs-property\"\u003eraw\u003c/span\u003e);\n  } \u003cspan class=\"hljs-keyword\"\u003ecatch\u003c/span\u003e (err) {\n    request.\u003cspan class=\"hljs-property\"\u003elog\u003c/span\u003e.\u003cspan class=\"hljs-title function_\"\u003eerror\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\u0026quot;react-flight err\u0026quot;\u003c/span\u003e, err);\n    \u003cspan class=\"hljs-keyword\"\u003ethrow\u003c/span\u003e err;\n  }\n});\n\u003c/code\u003e\u003c/pre\u003e\u003cul\u003e\n\u003cli\u003eThis will actually render your app based on what your App.jsx has (whereas we were \u0026quot;rendering\u0026quot; it ourselves before.)\u003c/li\u003e\n\u003cli\u003eThe way we coded this it will only really work for the base route of your app. If you tried to introduce a router or more components here, we haven\u0026#39;t provided for the ability to route to different routes. You\u0026#39;d have to code that up yourself.\u003c/li\u003e\n\u003cli\u003eLikewise we\u0026#39;re not handing any props to App.\u003c/li\u003e\n\u003cli\u003eThis is \u003cem\u003enot\u003c/em\u003e server-side rendering. The way you\u0026#39;d do that is you\u0026#39;d render the React Flight protocol, dump it into a script tag in the HTML, and have your app read that and use it to render your app on load. A little awkward but again, generally your framework will handle that for you.\u003c/li\u003e\n\u003cli\u003eCheck out the react-flight request in your network tab to see how it gets rendered out.\u003c/li\u003e\n\u003cli\u003eI also like it shows you \u003ccode\u003eServer\u003c/code\u003e logs directly in the browser, makes it easy to see client and server console.logs in the same place.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eSo there you go! Now your app is rendering partially on the server, partially on the client, and you\u0026#39;ve hand-coded it all! This is a pain to do but once you involve a framework like Next.js this gets so much easier. Still, amazing job! Hopefully you peeked a little bit behind the curtain to see what React is doing for you.\u003c/p\u003e\n","markdown":"\nSo now we have a React app ready to be served to clients. Let's write a quick Fastify server to do this. I just chose Fastify because I like it; there's no reason you couldn't do Express, Restify, or any other API framework for Node.js.\n\nLet's create a `server` directory in the root directory of our project. Put in there a main.js file and put in there\n\n```javascript\nconst reactServerregister = require(\"react-server-dom-webpack/node-register\");\nreactServerregister();\n\nconst babelRegister = require(\"@babel/register\");\nbabelRegister({\n  ignore: [/[\\\\\\/](dist|server|node_modules)[\\\\\\/]/],\n  plugins: [\"@babel/transform-modules-commonjs\"],\n});\n\nrequire(\"./server\")();\n```\n\n- We're doing CommonJS for our server portion. I had it working with ES modules but it took so much extra code that this was simpler to teach you. Feel free to convert it later yourself. Everything else in this course will be ES modules.\n- This file does three things: it makes our Node.js server able to read React/JSX files, it makes it able to ES modules in our client code, and it makes it able to do RSCs via the webpack bundler by hooking into the module systems to render some portions and not others. Remember the `--conditions react-server` that we have in our CLI command? This is what that is for.\n- Why is this in a separate file? It's so all subsequent `require`/`import` calls can be run through Babel and the react-server-dom-webpack modules.\n\nOkay, let's start crafting our server.js file in the same directory. Let's just start with the basic machinery.\n\n```javascript\nconst path = require(\"node:path\");\nconst { readFileSync } = require(\"node:fs\");\nconst Fastify = require(\"fastify\");\nconst fastifyStaticPlugin = require(\"@fastify/static\");\nconst React = require(\"react\");\nconst { renderToPipeableStream } = require(\"react-server-dom-webpack/server\");\nconst AppImport = require(\"../src/App.jsx\");\n\nconst App = AppImport.default;\n\nconst MANIFEST = readFileSync(\n  path.resolve(__dirname, \"../dist/react-client-manifest.json\"),\n  \"utf8\"\n);\nconst MODULE_MAP = JSON.parse(MANIFEST);\nconst PORT = process.env.PORT ? process.env.PORT : 3000;\n\nconst fastify = Fastify({\n  logger: {\n    transport: {\n      target: \"pino-pretty\",\n    },\n  },\n});\n\nfastify.register(fastifyStaticPlugin, {\n  root: path.join(__dirname, \"../dist\"),\n  prefix: \"/assets/\",\n});\n\nfastify.register(fastifyStaticPlugin, {\n  root: path.join(__dirname, \"../public\"),\n  decorateReply: false,\n});\n\nfastify.get(\"/\", async function rootHandler(request, reply) {\n  return reply.sendFile(\"index.html\");\n});\n\nfastify.get(\"/react-flight\", function reactFlightHandler(request, reply) {\n  // we'll do this code in a sec\n});\n\nmodule.exports = async function start() {\n  try {\n    await fastify.listen({ port: PORT });\n  } catch (err) {\n    fastify.log.error(err);\n    process.exit(1);\n  }\n};\n```\n\n- Pretty standard Fastify app. We're serving two static folders, `public` which is our CSS but also could be images and some other stuff. It's stuff that doesn't need to be compiled and just served directly. `dist` is our compiled Webpack stuff.\n- We're importing `react-server-dom-webpack/server` to be able to correctly serve our app here momentarily.\n- Same with our App.jsx. Notice we're not importing Client.jsx - that's all code that'll only execute client side.\n- The module map is something that `react-server-dom-webpack` generates and let's React how to know what module to what.\n\nAlright, let's render our app next. But let's cheat. Let's just give it directly some \"React Flight\" to render instead of the actual app.\n\n```javascript\n// replace the react-flight route\nfastify.get(\"/react-flight\", function reactFlightHandler(request, reply) {\n  try {\n    reply.header(\"Content-Type\", \"application/octet-stream\");\n    // be careful about whitespace as React Flight is sensitive to it. Make your editor isn't inserting any\n    return reply.send(`1:{\"name\":\"App\",\"env\":\"Server\",\"key\":null,\"owner\":null,\"props\":{}}\n0:D\"$1\"\n0:[\"$\",\"div\",null,{\"children\":[\"$\",\"h1\",null,{\"children\":\"Notes App\"},\"$1\"]},\"$1\"]\n`);\n  } catch (err) {\n    request.log.error(\"react-flight err\", err);\n    throw err;\n  }\n});\n```\n\n\u003e 💡 This is prone to breaking as this protocol is unstable and they may choose to change it in the future. However the principles remain the same. If you see something about webpack complaining in the errors, just skip this code sample and go to the next code block.\n\n- So what is that weird string in there? It's called React Flight Protocol and it's how React's server and client protocol work with each other.\n- You'll never write this by hand. But I wanted to show you it's not very scary, it's just a DSL for communicating between a client and a server, and in theory you could hand author it - you just never would.\n\nLet's take it one half step further.\n\n```javascript\n// replace reply.send\n\n// be careful about whitespace as React Flight is sensitive to it. Make your editor isn't inserting any\nreturn reply.send(`3:I[\"./src/ClientComponent.jsx\",[\"vendors-node_modules_react_jsx-dev-runtime_js\",\"vendors-node_modules_react_jsx-dev-runtime_js.chunk.js\",\"client0\",\"client0.chunk.js\"],\"\"]\n1:{\"name\":\"App\",\"env\":\"Server\",\"key\":null,\"owner\":null,\"props\":{}}\n0:D\"$1\"\n0:[\"$\",\"div\",null,{\"children\":[[\"$\",\"h1\",null,{\"children\":\"Notes App\"},\"$1\"],[\"$\",\"$L3\",null,{},\"$1\"]]},\"$1\"]\n`);\n```\n\n- This may not work for you due to paths (and again, you'd never hand author this so don't worry if it doesn't.)\n- This is cool though because you can see how React is referencing a client component. It's basically saying here's a div, and in it has an h1 and a \"$L3\". It then defines a \"3\" on the first line where it has `3:I`. Here it's saying anywhere that you have a 3 component, it refers to a ClientComponent, and that's going to be in this specific bundle, go find that and use it.\n- Pretty cool, right?\n- I genuinely don't know what some of the pieces here do, but it's fun to hack around and see what you can bend React to do.\n\nOkay, let's actually put the real code in here.\n\n```javascript\nfastify.get(\"/react-flight\", function reactFlightHandler(request, reply) {\n  try {\n    reply.header(\"Content-Type\", \"application/octet-stream\");\n    const { pipe } = renderToPipeableStream(\n      React.createElement(App),\n      MODULE_MAP\n    );\n    pipe(reply.raw);\n  } catch (err) {\n    request.log.error(\"react-flight err\", err);\n    throw err;\n  }\n});\n```\n\n- This will actually render your app based on what your App.jsx has (whereas we were \"rendering\" it ourselves before.)\n- The way we coded this it will only really work for the base route of your app. If you tried to introduce a router or more components here, we haven't provided for the ability to route to different routes. You'd have to code that up yourself.\n- Likewise we're not handing any props to App.\n- This is _not_ server-side rendering. The way you'd do that is you'd render the React Flight protocol, dump it into a script tag in the HTML, and have your app read that and use it to render your app on load. A little awkward but again, generally your framework will handle that for you.\n- Check out the react-flight request in your network tab to see how it gets rendered out.\n- I also like it shows you `Server` logs directly in the browser, makes it easy to see client and server console.logs in the same place.\n\nSo there you go! Now your app is rendering partially on the server, partially on the client, and you've hand-coded it all! This is a pain to do but once you involve a framework like Next.js this gets so much easier. Still, amazing job! Hopefully you peeked a little bit behind the curtain to see what React is doing for you.\n","slug":"the-rsc-server","title":"The RSC Server","section":"RSCs without a Framework","icon":"file-code","filePath":"/home/runner/work/intermediate-react-v6/intermediate-react-v6/lessons/03-rscs-without-a-framework/D-the-rsc-server.md","nextSlug":"/lessons/rscs-with-nextjs/abbreviated-intro-to-nextjs","prevSlug":"/lessons/rscs-without-a-framework/server-and-client-components"}},"__N_SSG":true},"page":"/lessons/[section]/[slug]","query":{"section":"rscs-without-a-framework","slug":"the-rsc-server"},"buildId":"81bftuYLGkwiC8AXLtnRs","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>